# 相机标定公式推导（Top-Down方式）

相机标定的核心是建立**真实世界3D点**到**图像2D像素点**的精确映射关系。我们从整体投影模型出发，逐步分解各个组成部分的公式。

---

## 1. 整体投影模型（Top层）

真实世界中的任意3D点  $(X_w, Y_w, Z_w)$  ，最终投影到图像像素点  $(u,v)$  的过程可概括为：

```
世界坐标系3D点 → 相机坐标系3D点 → 归一化图像平面2D点 → 畸变校正 → 像素坐标系2D点
```

对应的数学公式链为：

$$
P_w \xrightarrow{外参} P_c \xrightarrow{透视投影} P_{norm} \xrightarrow{畸变} P_{distorted} \xrightarrow{内参} p(u,v)
$$

其中：
-  $P_w$ : 世界坐标系下的3D点 $(X_w, Y_w, Z_w)$
-  $P_c$ : 相机坐标系下的3D点 $(X_c, Y_c, Z_c)$
-  $P_{norm}$ : 归一化图像平面上的2D点 $(x, y)$（单位：米）
-  $P_{distorted}$ : 畸变后的归一化图像点 $(x', y')$
-  $(u,v)$ : 最终图像像素点坐标 $(u, v)$（单位：像素）

---

## 2. 外参：世界坐标系 → 相机坐标系

外参描述相机在世界坐标系中的**位置和朝向**，包括：
- 旋转矩阵  $R$ : 3×3矩阵，描述坐标系旋转
- 平移向量  $t$ : 3×1向量，描述坐标系平移

转换公式：

$$
\begin{bmatrix} X_c \\ Y_c \\ Z_c \\ 1 \end{bmatrix} = \begin{bmatrix} R & t \\ 0^T & 1 \end{bmatrix} \begin{bmatrix} X_w \\ Y_w \\ Z_w \\ 1 \end{bmatrix}
$$

或简化为：

$$
P_c = R P_w + t
$$

**物理意义**：将世界坐标系中的点，通过旋转变换和平移变换，转换到相机坐标系下。

---

## 3. 透视投影：相机坐标系 → 归一化图像平面

相机坐标系下的3D点  $(X_c, Y_c, Z_c)$ ，通过透视投影（小孔成像原理）投射到归一化图像平面（位于相机光心前方，焦距  $f = 1$  处）：

$$
\begin{cases}
 x = \frac{X_c}{Z_c} \\ 
 y = \frac{Y_c}{Z_c} \\ 
 z = 1
\end{cases}
$$

**物理意义**：
-  $Z_c$  是点到相机的距离（深度）
- 归一化平面上的点  $(x, y)$  是无量纲的「射线方向」

---

## 4. 畸变模型：归一化平面 → 畸变图像平面

由于镜头制造误差，真实世界的直线会在图像中产生弯曲（畸变）。主要包括两种畸变：

### 4.1 径向畸变（Radial Distortion）

由镜头形状不完美导致，离光心越远的点畸变越严重。公式：

$$
\begin{cases}
 x' = x(1 + k_1 r^2 + k_2 r^4 + k_3 r^6) \\ 
 y' = y(1 + k_1 r^2 + k_2 r^4 + k_3 r^6)
\end{cases}
$$

其中：
-  $r^2 = x^2 + y^2$ : 归一化点到光心的距离平方
-  $k_1, k_2, k_3$ : 径向畸变系数

**物理意义**：
-  $k_1 > 0$ : 桶形畸变（图像边缘向外膨胀）
-  $k_1 < 0$ : 枕形畸变（图像边缘向内收缩）

### 4.2 切向畸变（Tangential Distortion）

由镜头与传感器安装不平行导致，表现为图像中物体的倾斜。公式：

$$
\begin{cases}
 x' = x + [2p_1 xy + p_2(r^2 + 2x^2)] \\ 
 y' = y + [p_1(r^2 + 2y^2) + 2p_2 xy]
\end{cases}
$$

其中：
-  $(p_1, p_2)$ : 切向畸变系数
-  $r^2 = x^2 + y^2$ : 归一化点到光心的距离平方

### 4.3 综合畸变公式

将径向畸变和切向畸变合并，得到最终的畸变校正公式：

$$
\begin{cases}
 x' = x(1 + k_1 r^2 + k_2 r^4 + k_3 r^6) + [2p_1 xy + p_2(r^2 + 2x^2)] \\ 
 y' = y(1 + k_1 r^2 + k_2 r^4 + k_3 r^6) + [p_1(r^2 + 2y^2) + 2p_2 xy]
\end{cases}
$$

---

## 5. 内参：畸变图像平面 → 像素坐标系

内参矩阵描述相机内部的物理特性（焦距、像素尺寸、主点位置等），将畸变后的归一化点转换为最终的像素坐标。

### 5.1 内参矩阵定义

相机内参矩阵  $K$  为：

$$
K = \begin{bmatrix} 
 f_x & s & c_x \\ 
 0 & f_y & c_y \\ 
 0 & 0 & 1 \\ 
\end{bmatrix}
$$

其中：
-  $f_x = f \cdot \alpha$ : 水平方向焦距（单位：像素）
-  $f_y = f \cdot \beta$ : 垂直方向焦距（单位：像素）
-  $\alpha, \beta$ : 像素在x/y方向的物理尺寸（单位：像素/米）
-  $s$ : 像素偏斜因子（理想情况下为0）
-  $(c_x, c_y)$ : 主点坐标（光轴与传感器的交点，单位：像素）

### 5.2 像素坐标转换

畸变后的归一化点  $(x', y')$  转换为像素坐标  $(u, v)$  的公式：

$$
\begin{bmatrix} u \\ v \\ 1 \end{bmatrix} = K \begin{bmatrix} x' \\ y' \\ 1 \end{bmatrix}
$$

展开为：

$$
\begin{cases}
 u = f_x \cdot x' + s \cdot y' + c_x \\ 
 v = f_y \cdot y' + c_y
\end{cases}
$$

**物理意义**：将归一化平面上的点（米单位）转换为传感器上的像素位置。

---

## 6. 完整投影公式（合并所有步骤）

将上述所有步骤合并，可得到从世界3D点到图像像素点的完整映射公式：

### 6.1 无畸变情况（简化版）

$$
\begin{bmatrix} u \\ v \\ 1 \end{bmatrix} = K \cdot [R | t] \cdot \begin{bmatrix} X_w \\ Y_w \\ Z_w \\ 1 \end{bmatrix}
$$

其中  $[R | t]$  是外参矩阵（3×4）。

### 6.2 含畸变情况（完整版）

$$
\begin{cases}
 X_c = R_{11}X_w + R_{12}Y_w + R_{13}Z_w + t_x \\ 
 Y_c = R_{21}X_w + R_{22}Y_w + R_{23}Z_w + t_y \\ 
 Z_c = R_{31}X_w + R_{32}Y_w + R_{33}Z_w + t_z \\ \\ 
 x = \frac{X_c}{Z_c}, \quad y = \frac{Y_c}{Z_c} \\ \\ 
 r^2 = x^2 + y^2 \\ \\ 
 x' = x(1 + k_1 r^2 + k_2 r^4 + k_3 r^6) + 2p_1 xy + p_2(r^2 + 2x^2) \\ 
 y' = y(1 + k_1 r^2 + k_2 r^4 + k_3 r^6) + p_1(r^2 + 2y^2) + 2p_2 xy \\ \\ 
 u = f_x x' + s y' + c_x \\ 
 v = f_y y' + c_y
\end{cases}
$$

---

## 7. 相机标定的优化问题

相机标定的本质是**参数估计问题**：已知一组世界点  $(P_w^i)$  和对应的图像像素点  $(p^i(u_i, v_i))$ ，求解相机的内参  $K$ 、畸变系数  $(k_1, k_2, k_3, p_1, p_2)$  和外参  $(R_i, t_i)$ （每张标定图像对应一组外参）。

### 7.1 优化目标

最小化**重投影误差**：即实际像素点与理论投影点之间的欧氏距离平方和：

$$
\min_{K, D, R_i, t_i} \sum_{i=1}^{n} \sum_{j=1}^{m} \left\| p^i_j - \hat{p}^i_j(K, D, R_i, t_i) \right\|^2
$$

其中：
-  $n$ : 标定图像数量
-  $m$ : 每张图像上的标定点数
-  $p^i_j$ : 第$i$张图像上第$j$个点的实际像素坐标
-  $\hat{p}^i_j$ : 第$i$张图像上第$j$个点的理论投影坐标
-  $(k_1, k_2, k_3, p_1, p_2)$ : 畸变系数集合 

### 7.2 求解方法

通常使用**非线性最小二乘法**（如Levenberg-Marquardt算法）求解上述优化问题。经典的张正友标定法采用两步法：

1. **线性求解**：忽略畸变，求解内参和外参的初始值
2. **非线性优化**：加入畸变模型，对所有参数进行精细化优化

---

## 8. 标定参数总结

通过相机标定，我们最终得到以下参数：

| 参数类型 | 符号 | 含义 | 维度 |
|---------|------|------|------|
| 内参矩阵 |  $K$  | 焦距、主点、像素尺寸 | 3×3 |
| 径向畸变系数 |  $(k_1, k_2, k_3)$  | 镜头径向畸变程度 | 标量 |
| 切向畸变系数 |  $(p_1, p_2)$  | 镜头切向畸变程度 | 标量 |
| 外参（每张图像） |  $(R_i, t_i)$  | 相机在世界坐标系中的姿态 | 3×3, 3×1 |

---

## 9. 应用：畸变校正与逆投影

### 9.1 畸变校正

已知标定参数后，可以对畸变图像进行校正：

$$
\begin{cases}
 x = \frac{u - c_x}{f_x} - \frac{s}{f_x}y' \\ 
 y = \frac{v - c_y}{f_y} \\ \\ 
 r^2 = x^2 + y^2 \\ \\ 
 x_{undistorted} = x(1 - k_1 r^2 - k_2 r^4 - k_3 r^6) + ... \\ 
 y_{undistorted} = y(1 - k_1 r^2 - k_2 r^4 - k_3 r^6) + ... \\ \\ 
 u_{undistorted} = f_x x_{undistorted} + c_x \\ 
 v_{undistorted} = f_y y_{undistorted} + c_y
\end{cases}
$$

### 9.2 逆投影（3D重建）

已知像素点和深度信息  $Z_c$ ，可以反推相机坐标系下的3D点：

$$
\begin{cases}
 X_c = Z_c \cdot \frac{u - c_x}{f_x} \\ 
 Y_c = Z_c \cdot \frac{v - c_y}{f_y} \\ 
 Z_c = Z_c
\end{cases}
$$

---

# 总结

相机标定的核心是通过**已知对应点**求解**投影模型参数**，从而建立像素世界与真实世界的精确映射。从公式角度看，这是一个包含**外参变换**、**透视投影**、**畸变校正**和**内参映射**的完整数学链。

标定完成后，我们可以利用这些参数进行：
- 图像畸变校正
- 3D测量与重建
- 增强现实（AR）
- 机器人视觉导航

